FROM golang:1.23-alpine

WORKDIR /app

RUN apk add --no-cache \
    git \
    gcc \
    musl-dev \
    nodejs \
    npm

RUN go install github.com/cosmtrek/air@latest

COPY tailwind/package*.json ./tailwind/
WORKDIR /app/tailwind
RUN npm ci

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY tailwind/tailwind.config.js ./tailwind/
COPY tailwind/postcss.config.js ./tailwind/

RUN echo 'root = "." \n\
tmp_dir = "tmp" \n\
\n\
[build] \n\
  cmd = "go build -o ./tmp/main ./cmd/server" \n\
  bin = "tmp/main" \n\
  include_ext = ["go", "gohtml"] \n\
  exclude_dir = ["tmp", "vendor", "node_modules"] \n\
  delay = 1000 \n\
\n\
[color] \n\
  main = "magenta" \n\
  watcher = "cyan" \n\
  build = "yellow" \n\
  runner = "green" \n\
' > .air.toml

EXPOSE 3000

CMD sh -c "cd /app/tailwind && npm run watch:css & cd /app && air"
